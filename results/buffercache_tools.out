CREATE DATABASE test_database;
\c test_database;
CREATE EXTENSION buffercache_tools;
CREATE TABLE test_table(col integer) 
    WITH (autovacuum_enabled = off);
-- check pg_show_relation_buffers() 
SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
(0 rows)

INSERT INTO test_table 
    SELECT 1 FROM generate_series(1,1000); 
SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | f     |          5 |       0 | fsm
           1 | f     |          1 |       0 | fsm
           2 | f     |          4 |       0 | fsm
           0 | t     |          5 |       0 | main
           1 | t     |          5 |       0 | main
           2 | t     |          5 |       0 | main
           3 | t     |          5 |       0 | main
           4 | t     |          5 |       0 | main
(8 rows)

VACUUM test_table;
SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | t     |          5 |       0 | fsm
           1 | t     |          2 |       0 | fsm
           2 | t     |          5 |       0 | fsm
           0 | t     |          5 |       0 | main
           1 | t     |          5 |       0 | main
           2 | t     |          5 |       0 | main
           3 | t     |          5 |       0 | main
           4 | t     |          5 |       0 | main
           0 | t     |          2 |       0 | vm
(9 rows)

TRUNCATE TABLE test_table;
-- check pg_flush_buffer()
INSERT INTO test_table 
    SELECT 1 FROM generate_series(1,1000); 
SELECT pg_flush_buffer(
    ( 
        SELECT buffernumber 
            FROM pg_show_relation_buffers('test_table') 
            LIMIT 1
    )::integer
);
 pg_flush_buffer 
-----------------
 t
(1 row)

SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | f     |          5 |       0 | fsm
           1 | f     |          1 |       0 | fsm
           2 | f     |          4 |       0 | fsm
           0 | t     |          5 |       0 | main
           1 | t     |          5 |       0 | main
           2 | t     |          5 |       0 | main
           3 | t     |          5 |       0 | main
           4 | f     |          5 |       0 | main
(8 rows)

-- check pg_mark_buffer_dirty()
SELECT pg_mark_buffer_dirty(
    (
        SELECT buffernumber 
        FROM pg_show_relation_buffers('test_table') 
        LIMIT 1
    )::integer
);
 pg_mark_buffer_dirty 
----------------------
 t
(1 row)

SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | f     |          5 |       0 | fsm
           1 | f     |          1 |       0 | fsm
           2 | f     |          4 |       0 | fsm
           0 | t     |          5 |       0 | main
           1 | t     |          5 |       0 | main
           2 | t     |          5 |       0 | main
           3 | t     |          5 |       0 | main
           4 | t     |          5 |       0 | main
(8 rows)

-- check pg_flush_relation_fork_buffers()
SELECT pg_flush_relation_fork_buffers('test_table', 'main');
 pg_flush_relation_fork_buffers 
--------------------------------
 t
(1 row)

SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | f     |          5 |       0 | fsm
           1 | f     |          1 |       0 | fsm
           2 | f     |          4 |       0 | fsm
           0 | f     |          5 |       0 | main
           1 | f     |          5 |       0 | main
           2 | f     |          5 |       0 | main
           3 | f     |          5 |       0 | main
           4 | f     |          5 |       0 | main
(8 rows)

-- check pg_flush_database_buffers()
VACUUM test_table;
SELECT pg_flush_database_buffers(
    (
        SELECT oid 
            FROM pg_database 
            WHERE datname = 'test_database'
    )::oid
);
 pg_flush_database_buffers 
---------------------------
 t
(1 row)

SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | f     |          5 |       0 | fsm
           1 | f     |          2 |       0 | fsm
           2 | f     |          5 |       0 | fsm
           0 | f     |          5 |       0 | main
           1 | f     |          5 |       0 | main
           2 | f     |          5 |       0 | main
           3 | f     |          5 |       0 | main
           4 | f     |          5 |       0 | main
           0 | f     |          2 |       0 | vm
(9 rows)

-- check pg_read_page_into_buffer()
SELECT 1 
    FROM pg_read_page_into_buffer('test_table', 'main', 0);
 ?column? 
----------
        1
(1 row)

SELECT blocknumber, dirty, usagecount, pinning, fork 
    FROM pg_show_relation_buffers('test_table') 
    ORDER BY fork, blocknumber;
 blocknumber | dirty | usagecount | pinning | fork 
-------------+-------+------------+---------+------
           0 | f     |          5 |       0 | fsm
           1 | f     |          2 |       0 | fsm
           2 | f     |          5 |       0 | fsm
           0 | f     |          5 |       0 | main
           1 | f     |          5 |       0 | main
           2 | f     |          5 |       0 | main
           3 | f     |          5 |       0 | main
           4 | f     |          5 |       0 | main
           0 | f     |          2 |       0 | vm
(9 rows)

SELECT 1 
    FROM pg_read_page_into_buffer('test_table', 'main', 0);
 ?column? 
----------
        1
(1 row)

DROP TABLE test_table;
\c template1
DROP DATABASE test_database;
